---
title: 'VariSel : An a R package to perform variable selection in linear models'
author: "Marie"
date: "3 février 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(VariSel)
require(tidyverse)
require(tidymodels)
require(viridis)
require(furrr)
require(rlang)
require(knitr)
theme_set(theme_bw() + theme_light() +
            theme(strip.background = element_rect(fill = "white", color ="gray"), 
                  strip.text = element_text(color = "black"),
                  text = element_text(face="bold", family="LM Roman 10", size =18),
                  legend.key.height = unit(0.3,units = "cm"),
                  plot.title = element_text(hjust = 0.5, size =32),
                  panel.grid = element_blank()))
scale_fill_continuous <- function(...) scale_fill_viridis()
scale_fill_discrete <- function(...) scale_fill_viridis(discrete = TRUE)
scale_colour_discrete <- function(...) scale_color_viridis()
scale_colour_discrete <- function(...) scale_color_viridis(discrete = TRUE)


```

## Introduction 


## First exemples : Iris dataset

```{r}
lirbary(car)
iris %>% 
  head() %>% 
  kable()
```

### Associtaion between sepal characteristics and petal characteristics

The aim of this exemple is to select association between the Sepal (Length and width) and the Petal (Length and Width). 

Construction of the matrices  :

```{r}
Y <- iris %>% select( starts_with("Sepal"))
Petal_char <- iris %>% select( starts_with("Petal"))
```

Coefficient estimation using a lasso criterion: 


```{r}
mod <-  train_VariSel( Y = Y, 
                       X = Petal_char, 
                       type ="lasso_univ")
```

```{r}
plot(mod)
```

It start by selecting an association between the petal length and the sepal length and then an association between the petal lenght and the sepal widthand so on..

Let us now see what happened when we use group lasso to force the association to be between one sepal characteristics with all petal characteristics. 

```{r}
mod_group <-  train_VariSel( Y = Y, 
                       X = Petal_char, 
                       type ="group_multi_regr", 
                       sepx = "\\.")
```

The argument ~sepx = "\\."~ mean that the name of X will be seperate into a group name and a characteristics name. 
Two variables having the same group name will be selected together. Here both Petal.length and Petal.Width start with Petal hence they will be selected together. 

```{r}
plot(mod_group)
```

Let's now compare differents types grouping or not the petal characteristics and influence it or not to have the same coefficients. 

```{r}
ct <- compar_type( Y = Y, X = Petal_char,  
  types = c("group_multi_regr" , "group_multi_both" ,
  "fused_multi_regr", "fused_multi_both",
  "lasso_multi", "lasso_univ" ), times = 10)
plot_ct(ct)
```

We can also propose different associations between petal characteristics and sepal charcateristics depending on the species. 


```{r}
mod_group_species <-  train_VariSel( Y = Y, 
                       regressors =  Petal_char, 
                       group = iris$Species,
                       type ="group_multi_regr")
```

```{r}
plot(mod_group_species)
```

```{r, echo=FALSE}
col <- pal_uchicago()(6)

mod_group_resp_species <-  train_VariSel( Y = Y,
                       regressors = Petal_char, 
                       group = iris$Species, 
                       type ="group_multi_both")

mod_fused_multi_species <-  train_VariSel( Y = Y,
                       regressors = Petal_char, 
                       group = iris$Species, 
                       type ="fused_multi_regr")
mod_fused_multi_species_resp <-  train_VariSel( Y = Y,
                       regressors = Petal_char, 
                       group = iris$Species, 
                       type ="fused_multi_both")


```

```{r}
compar_path(mods = list(mod_group_species,
                        mod_group_resp_species,
                        mod_fused_multi_species,
                        mod_fused_multi_species_resp))
```


```{r}
mod_lasso <-   train_VariSel( Y = Y,
                       regressors = Petal_char, 
                       group = iris$Species, 
                       type ="lasso_multi")
```
 
 
```{r}
plot(mod_lasso)
```
 

## A more serious exemple 

we will now use the dataset available and described in "A global dataset of CO2 emissions and ancillary data related to emissions for 343 cities"

The data are available in https://www.nature.com/articles/sdata2018280?WT.feed_name=subjects_environmental-social-sciences

```{r}
CO2 <-xlsx::read.xlsx(file="Data/D_FINAL.xlsx", sheetIndex =1, header=TRUE)
dim(CO2)
cc <-complete.cases(CO2[,c("Scope.1.GHG.emissions..tCO2.or.tCO2.eq.",
                      "Scope.2..CDP...tCO2.eq.",
                      "Average.altitude..m.",
                      "Average.annual.temperature..CDP...degrees.Celsius.")])
CO2_full <- CO2[cc, ]
CO2_quant <- CO2_full %>% select_if(is.numeric)
CO2_quant_full <- CO2_quant[,complete.cases(t(CO2_quant))]
```


```{r}
Y <- CO2_quant_full[,c("Scope.1.GHG.emissions..tCO2.or.tCO2.eq.",
                      "Scope.2..CDP...tCO2.eq.")] %>% 
  scale()
CO2_quant_full_exp <-CO2_quant_full %>%
  select(-Scope.1.GHG.emissions..tCO2.or.tCO2.eq.,
    -Scope.2..CDP...tCO2.eq.,
    -Total.emissions..CDP...tCO2.eq.) %>% scale()
```


First model : association between in different region 


```{r}
mod_lasso <- train_VariSel(Y = Y, 
                           X = CO2_quant_full_exp,
                           type = "lasso_multi")
plot(mod_lasso)
```


```{r}
mod_lasso_reg <- train_VariSel(Y = Y, 
                           regressors = CO2_quant_full_exp,
                           group = as.character(CO2_full$Region),
                           type = "lasso_multi")
plot(mod_lasso_reg)
```



```{r}
mod_lasso_reg <- train_VariSel(Y = Y, 
                           regressors = CO2_quant_full_exp,
                           group = as.character(CO2_full$Region),
                           type = "group_multi_regr")
plot(mod_lasso_reg, n =8)
```

```{r}
mod_lasso_reg <- train_VariSel(Y = Y, 
                           regressors = CO2_quant_full_exp,
                           group = as.character(CO2_full$Region),
                           type = "group_multi_both")
plot(mod_lasso_reg, n =6)
```


```{r}
mod_lasso_reg <- train_VariSel(Y = Y, 
                           regressors = CO2_quant_full_exp,
                           group = as.character(CO2_full$Region),
                           type = "fused_multi_both")
plot(mod_lasso_reg, n =6)
```



```{r}
plan(multiprocess)
ct <- compar_type(Y = Y, 
        regressors = CO2_quant_full_exp,
        group = as.character(CO2_full$Region),
        types = c("group_multi_regr" , "group_multi_both" ,
          "fused_multi_regr", "fused_multi_both",
          "lasso_multi", "lasso_univ" ))
plot_ct(ct)

bm <- get_best_models(ct)


plot_md(bm)
```


```{r}
set.seed(123)
n <- 1000
p <- 5
q <- 2
s <- 0.1
group <- sample(c("lapin", "chat"), n, replace = TRUE)
kable(table(group))
R <- matrix(rpois(n * p, 1), ncol = p)
X <- model.matrix(~R:group -1)
B <- matrix(0, ncol = q, nrow = p *2)
B[grepl("R1", colnames(X)),] <- 1
B[grepl("R2", colnames(X)),] <- 2
# B[grepl("R3:grouplapin", colnames(X)),2] <- 1.5
Y <- X %*% B + matrix(rnorm(n * q), ncol =q)

plan(multiprocess)
ct <- compar_type(X, Y, types = c("group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ),
                  sep =":")
plot_ct(ct)
mb <- get_best_models(ct,criterion = "BIC")
plot_md(mb)

```


```{r}
load('datatest_VVIV04.Rdata')
```


## Model selection 

```{r}
system.time(
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" )))

```


```{r}
plan(multiprocess)
system.time(
ct <- compar_type(X, Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" )))

```


```{r}
require(microbenchmark)

mb <- microbenchmark(
  {plan(multiprocess) ;
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ))}, 
{plan(sequential) ;
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ))
                              },
times = 10)
autoplot(mb) + scale_x_discrete(labels =c("a","b"))
```


```{r}

 ct$all_res %>% group_by(key, type) %>% filter(type!="fus2resp") %>% 
  summarise(MSE = mean(MSE_boot), BIC = mean(BIC), lambda1 = mean(lambda1)) %>% 
  ggplot(aes(x = lambda1, color = type, fill = type, y = BIC, shape = type)) +
  geom_line() + theme_bw() + geom_point()+ scale_x_log10()+
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") 


 ct$all_res %>% group_by(key, type) %>% 
  summarise(MSE = mean(MSE_boot), BIC = mean(BIC), lambda1 = mean(lambda1)) %>% 
   gather(key  = criterion, value = value, - key, -type, -lambda1) %>% 
  ggplot(aes(x = lambda1, color = type, fill = type, y = value, shape = type)) +
  geom_line() + theme_bw() + geom_point()+ scale_x_log10()+
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") +
   facet_wrap(~criterion,scale= "free")
```

```{r}
 ct %>% mutate(key = as.numeric(gsub('s','',key))) %>%
  ggplot(aes(x = key, color = type,fill = type, y = value)) +
  geom_smooth() + theme_bw() +
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") + 
  facet_grid(~Trait) 
```


```{r}
mb <-get_best_models(ct,criterion = "MSE_boot")
plot_md(mb, types = c("lasso_mutl","group_multi_marker","group_multi_both","fused_univ","fused_multi_regr"))
```





Chere marie du future,
Le probleme vient du pmap qui calcul le bic dans QTLmodclass. 
regarde le df lasso de efron et tout telechargé dans varisel


faire une méthode compar_result qui compare les coefficients obtenu par les différents modèles. 

ajouter aussi une fçon simple de récupérer les BIC des modèles sans pour autant faire du bootstrap et tous le bordel
