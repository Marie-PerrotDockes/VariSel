---
title: 'VariSel : An a R package to perform variable selection in linear models'
author: "Marie"
date: "3 février 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(VariSel)
require(tidyverse)
require(tidymodels)
require(viridis)
require(furrr)
require(rlang)
theme_set(theme_bw() + theme_light() +
            theme(strip.background = element_rect(fill = "white", color ="gray"), 
                  strip.text = element_text(color = "black"),
                  text = element_text(face="bold", family="LM Roman 10", size =18),
                  legend.position = "bottom" , legend.key.width = unit(2.5,units = "cm"),
                  legend.key.height = unit(0.3,units = "cm"),
                  plot.title = element_text(hjust = 0.5, size =32),
                  panel.grid = element_blank()))
scale_fill_continuous <- function(...) scale_fill_viridis()
scale_fill_discrete <- function(...) scale_fill_viridis(discrete = TRUE)
scale_colour_discrete <- function(...) scale_color_viridis()
scale_colour_discrete <- function(...) scale_color_viridis(discrete = TRUE)


```

## Introduction 


## Un exemple simple :

Nous avons deux variables réponses, 5 regresseurs et un variable catégorielle à deux modalités. 

```{r}
set.seed(123)
n <- 1000
p <- 5
q <- 2
s <- 0.1
group <- sample(c("lapin", "chat"), n, replace = TRUE)
kable(table(group))
R <- matrix(rpois(n * p, 1), ncol = p)
X <- model.matrix(~R:group -1)
B <- matrix(0, ncol = q, nrow = p *2)
B[grepl("R1", colnames(X)),] <- 1
B[grepl("R2", colnames(X)),] <- 2
# B[grepl("R3:grouplapin", colnames(X)),2] <- 1.5
Y <- X %*% B + matrix(rnorm(n * q), ncol =q)

plan(multiprocess)
ct <- compar_type(X, Y, types = c("group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ),
                  sep =":")
plot_ct(ct)
mb <- get_best_models(ct,criterion = "BIC")
plot_md(mb)

```


```{r}
load('datatest_VVIV04.Rdata')
```


## Model selection 

```{r}
system.time(
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" )))

```


```{r}
plan(multiprocess)
system.time(
ct <- compar_type(X, Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" )))

```


```{r}
require(microbenchmark)

mb <- microbenchmark(
  {plan(multiprocess) ;
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ))}, 
{plan(sequential) ;
ct <- compar_type(X[,1:10], Y, types = c("fus2resp",  "group_univ" ,"group_multi_both" ,"group_multi_marker" ,
                              "fused_univ" ,"fused_multi_both","fused_multi_regr",
                              "lasso_univ","lasso_multi" ))
                              },
times = 10)
autoplot(mb) + scale_x_discrete(labels =c("a","b"))
```


```{r}

 ct$all_res %>% group_by(key, type) %>% filter(type!="fus2resp") %>% 
  summarise(MSE = mean(MSE_boot), BIC = mean(BIC), lambda1 = mean(lambda1)) %>% 
  ggplot(aes(x = lambda1, color = type, fill = type, y = BIC, shape = type)) +
  geom_line() + theme_bw() + geom_point()+ scale_x_log10()+
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") 


 ct$all_res %>% group_by(key, type) %>% 
  summarise(MSE = mean(MSE_boot), BIC = mean(BIC), lambda1 = mean(lambda1)) %>% 
   gather(key  = criterion, value = value, - key, -type, -lambda1) %>% 
  ggplot(aes(x = lambda1, color = type, fill = type, y = value, shape = type)) +
  geom_line() + theme_bw() + geom_point()+ scale_x_log10()+
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") +
   facet_wrap(~criterion,scale= "free")
```

```{r}
 ct %>% mutate(key = as.numeric(gsub('s','',key))) %>%
  ggplot(aes(x = key, color = type,fill = type, y = value)) +
  geom_smooth() + theme_bw() +
  labs(y = "MSE", title ="Bootstrap MSE", x = "Regularization Path") + 
  facet_grid(~Trait) 
```


```{r}
mb <-get_best_models(ct,criterion = "MSE_boot")
plot_md(mb, types = c("lasso_mutl","group_multi_marker","group_multi_both","fused_univ","fused_multi_regr"))
```





Chere marie du future,
Le probleme vient du pmap qui calcul le bic dans QTLmodclass. 
regarde le df lasso de efron et tout telechargé dans varisel


faire une méthode compar_result qui compare les coefficients obtenu par les différents modèles. 

ajouter aussi une fçon simple de récupérer les BIC des modèles sans pour autant faire du bootstrap et tous le bordel
